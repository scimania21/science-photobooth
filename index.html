<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼í•™ë„¤ì»· ì‚¬ì§„ í•©ì„±ê¸°</title>
    <style>
        body{font-family:'Malgun Gothic',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;background-color:#f0f2f5;color:#333}
        .screen{display:none;width:100%;max-width:1000px;padding:20px;box-sizing:border-box;text-align:center}
        .screen.active{display:block}
        h1,h2{color:#2c3e50}
        button{background-color:#3498db;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;transition:background-color .3s;margin:5px}
        button:hover{background-color:#2980b9}
        button:disabled{background-color:#bdc3c7;cursor:not-allowed}
        #frame-selection .frame-options{display:flex;flex-direction:column;align-items:center;gap:20px}
        #frame-selection .frame-row{display:flex;justify-content:center;gap:20px;flex-wrap:wrap}
        #frame-selection img{box-sizing:border-box;width:200px;border:3px solid transparent;border-radius:10px;cursor:pointer;transition:border-color .3s,transform .3s;background-color:#fff}
        #frame-selection img:hover{border-color:#3498db;transform:scale(1.05)}
        #capture-screen video{width:100%;max-width:500px;border-radius:10px;background-color:#000}
        #thumbnails{display:flex;flex-wrap:nowrap;gap:10px;justify-content:flex-start;margin-top:15px;height:80px;overflow-y:hidden;overflow-x:auto;padding:10px;background:#fff;border-radius:5px}
        #thumbnails img{width:80px;height:60px;object-fit:cover;border-radius:5px;flex-shrink:0}
        #photo-selection .photo-grid{display:grid;grid-template-columns:repeat(5, 1fr);gap:15px;margin:20px 0}
        #photo-selection .photo-item img{width:100%;border-radius:5px;display:block;border:4px solid transparent;cursor:pointer;transition:border-color .2s}
        #photo-selection .photo-item img.selected{border-color:#3498db}
        #editor-screen canvas{border:2px solid #ccc;border-radius:5px;cursor:grab;max-width:100%;height:auto;touch-action:none}
        .instructions{background-color:#eaf5ff;border:1px solid #bce8f1;color:#31708f;padding:15px;border-radius:8px;margin-bottom:20px}
    </style>
</head>
<body>
    <div id="frame-selection" class="screen active">
        <h1>âœ¨ ê³¼í•™ë„¤ì»· ì‚¬ì§„ í•©ì„±ê¸° âœ¨</h1>
        <p class="instructions">ë§ˆìŒì— ë“œëŠ” í”„ë ˆì„ì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="frame-options">
            <div class="frame-row">
                <img src="1ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 1" data-frame="1ë²ˆ í”„ë ˆì„.png" data-photos="4" data-photo-slots="frame_01_slots">
                <img src="2ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 2" data-frame="2ë²ˆ í”„ë ˆì„.png" data-photos="4" data-photo-slots="frame_02_slots">
                <img src="3ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 3" data-frame="3ë²ˆ í”„ë ˆì„.png" data-photos="8" data-photo-slots="frame_03_slots">
                <img src="4ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 4" data-frame="4ë²ˆ í”„ë ˆì„.png" data-photos="4" data-photo-slots="frame_04_slots">
            </div>
            <div class="frame-row">
                <img src="5ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 5" data-frame="5ë²ˆ í”„ë ˆì„.png" data-photos="8" data-photo-slots="frame_05_slots">
                <img src="6ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 6" data-frame="6ë²ˆ í”„ë ˆì„.png" data-photos="6" data-photo-slots="frame_06_slots">
                <img src="7ë²ˆ í”„ë ˆì„.png" alt="í”„ë ˆì„ 7" data-frame="7ë²ˆ í”„ë ˆì„.png" data-photos="8" data-photo-slots="frame_07_slots">
            </div>
        </div>
    </div>
    <div id="capture-screen" class="screen">
        <h2>ğŸ“· ì‚¬ì§„ ì´¬ì˜</h2>
        <p class="instructions">ì´ 10ì¥ì˜ ì‚¬ì§„ì„ ì´¬ì˜í•©ë‹ˆë‹¤. ì›í•˜ëŠ” ì´¬ì˜ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        <video id="webcam" autoplay playsinline></video><br>
        <button id="capture-btn">ìˆ˜ë™ì´¬ì˜ (<span id="capture-count">0</span>/10)</button>
        <button id="auto-capture-1s-btn">1ì´ˆ ìë™ì´¬ì˜</button>
        <button id="auto-capture-3s-btn">3ì´ˆ ìë™ì´¬ì˜</button>
        <button id="next-to-selection-btn" disabled>ì‚¬ì§„ ì„ íƒí•˜ê¸°</button>
        <h3>ì´¬ì˜ëœ ì‚¬ì§„ ëª©ë¡</h3>
        <div id="thumbnails"></div>
    </div>
    <div id="photo-selection" class="screen">
        <h2>ğŸ–¼ï¸ ì‚¬ì§„ ì„ íƒ</h2>
        <p class="instructions">í”„ë ˆì„ì— ë„£ì„ <b id="required-photos-count"></b>ì¥ì˜ ì‚¬ì§„ì„ ì„ íƒí•œ í›„, 'í¸ì§‘ í™”ë©´ìœ¼ë¡œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        <div id="photo-grid-container" class="photo-grid"></div>
        <button id="next-to-editor-btn">í¸ì§‘ í™”ë©´ìœ¼ë¡œ</button>
    </div>
    <div id="editor-screen" class="screen">
        <h2>ğŸ¨ ì‚¬ì§„ í¸ì§‘</h2>
        <p class="instructions">ì‚¬ì§„ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì˜®ê¸°ê³ , í•¸ë“¤ì´ë‚˜ ë‹¨ì¶•í‚¤(W/A/S/D)ë¡œ í¬ê¸°ì™€ ë°©í–¥ì„ ì¡°ì ˆí•˜ì„¸ìš”.</p>
        <canvas id="canvas"></canvas>
        <div class="controls" style="margin-top:20px">
            <button id="download-btn">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
            <button id="print-btn">ì¸ì‡„í•˜ê¸°</button>
            <button id="restart-btn">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <script>
        const screens=document.querySelectorAll(".screen"),frameSelectionScreen=document.getElementById("frame-selection"),captureScreen=document.getElementById("capture-screen"),photoSelectionScreen=document.getElementById("photo-selection"),editorScreen=document.getElementById("editor-screen"),webcamElement=document.getElementById("webcam"),canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),captureBtn=document.getElementById("capture-btn"),autoCapture1sBtn=document.getElementById("auto-capture-1s-btn"),autoCapture3sBtn=document.getElementById("auto-capture-3s-btn"),captureCountSpan=document.getElementById("capture-count"),thumbnailsContainer=document.getElementById("thumbnails"),nextToSelectionBtn=document.getElementById("next-to-selection-btn"),photoGridContainer=document.getElementById("photo-grid-container"),requiredPhotosCountSpan=document.getElementById("required-photos-count"),nextToEditorBtn=document.getElementById("next-to-editor-btn"),downloadBtn=document.getElementById("download-btn"),printBtn=document.getElementById("print-btn"),restartBtn=document.getElementById("restart-btn");
        
        const shutterSound = new Audio('shutter.mp3');

        let state={selectedFrameSrc:null,selectedFrameType:null,requiredPhotos:0,capturedPhotos:[],editedPhotos:[],frameImage:null};let activePhoto=null,isDragging=!1,isResizing=!1,isRotating=!1,dragStartX,dragStartY;const handleSize=16;
        
        const frameSlots={
            "frame_01_slots":[[.0536,.2347,.4229,.3410],[.0536,.5927,.4229,.3410],[.5313,.0694,.4229,.3410],[.5313,.4264,.4229,.3410]],
            "frame_02_slots":[[.0651,.0317,.4209,.3968],[.0651,.4476,.4209,.3968],[.5140,.0810,.4209,.3968],[.5140,.5000,.4209,.3968]],
            "frame_03_slots":[[.1751,.1863,.2610,.1261],[.1751,.3353,.2610,.1261],[.1941,.4854,.2610,.1261],[.1960,.6398,.2610,.1261],[.5567,.2528,.2610,.1261],[.5577,.3991,.2610,.1261],[.5225,.5475,.2610,.1261],[.5078,.7043,.2610,.1261]],
            "frame_04_slots":[[.1591,.2090,.3361,.3079],[.5067,.2090,.3361,.3079],[.1591,.5257,.3361,.3079],[.5078,.5241,.3361,.3079]],
            "frame_05_slots":[[.0498,.0143,.4190,.1981],[.0498,.2286,.4190,.1981],[.0498,.4434,.4190,.1981],[.0498,.6579,.4190,.1981],[.5488,.0143,.4190,.1981],[.5488,.2286,.4190,.1981],[.5488,.4434,.4190,.1981],[.5488,.6579,.4190,.1981]],
            "frame_06_slots":[[.0629,.3656,.2821,.2021],[.3704,.3598,.2581,.1984],[.6532,.3735,.2709,.1952],[.0928,.6550,.2626,.1942],[.3771,.6688,.2447,.1884],[.6539,.6519,.2634,.1979]],
            "frame_07_slots":[[.0565,.1706,.3958,.1817],[.0565,.3728,.3958,.1817],[.0565,.5741,.3958,.1817],[.0565,.7767,.3958,.1817],[.5537,.1706,.3958,.1817],[.5537,.3728,.3958,.1817],[.5537,.5741,.3958,.1817],[.5537,.7767,.3958,.1817]]
        };
        Object.keys(frameSlots).forEach(key => { frameSlots[key].forEach(slot => { if (slot.length < 5) slot.push("square"); }); });

        function showScreen(e){screens.forEach(t=>{t.classList.remove("active")}),document.getElementById(e).classList.add("active")}frameSelectionScreen.addEventListener("click",e=>{"IMG"===e.target.tagName&&(state.selectedFrameSrc=e.target.dataset.frame,state.selectedFrameType=e.target.dataset.photoSlots,state.requiredPhotos=parseInt(e.target.dataset.photos),startWebcam())});async function startWebcam(){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});webcamElement.srcObject=e,showScreen("capture-screen")}catch(e){console.error("ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜:",e),alert("ì›¹ìº ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.")}}
        
        function takePhoto() {
            if (state.capturedPhotos.length >= 10) return;
            const e = document.createElement("canvas");
            e.width = webcamElement.videoWidth;
            e.height = webcamElement.videoHeight;
            const t = e.getContext("2d");
            t.translate(e.width, 0);
            t.scale(-1, 1);
            t.drawImage(webcamElement, 0, 0, e.width, e.height);
            
            shutterSound.currentTime = 0;
            shutterSound.play();
            
            const a = e.toDataURL("image/jpeg");
            state.capturedPhotos.push(a);
            const o = document.createElement("img");
            o.src = a;
            thumbnailsContainer.appendChild(o);
            captureCountSpan.textContent = state.capturedPhotos.length;
            if (state.capturedPhotos.length >= 10) {
                captureBtn.disabled = true;
                autoCapture1sBtn.disabled = true;
                autoCapture3sBtn.disabled = true;
                nextToSelectionBtn.disabled = false;
            }
        }

        function disableAllCaptureButtons() {
            captureBtn.disabled = true;
            autoCapture1sBtn.disabled = true;
            autoCapture3sBtn.disabled = true;
        }

        captureBtn.addEventListener("click", takePhoto);

        autoCapture1sBtn.addEventListener("click", () => {
            disableAllCaptureButtons();
            const intervalId = setInterval(() => {
                if (state.capturedPhotos.length < 10) {
                    takePhoto();
                } else {
                    clearInterval(intervalId);
                }
            }, 1000);
        });

        autoCapture3sBtn.addEventListener("click", () => {
            disableAllCaptureButtons();
            const intervalId = setInterval(() => {
                if (state.capturedPhotos.length < 10) {
                    takePhoto();
                } else {
                    clearInterval(intervalId);
                }
            }, 3000);
        });
        
        nextToSelectionBtn.addEventListener("click",()=>{webcamElement.srcObject&&webcamElement.srcObject.getTracks().forEach(e=>e.stop()),setupPhotoSelection()});
        function setupPhotoSelection(){photoGridContainer.innerHTML="",requiredPhotosCountSpan.textContent=state.requiredPhotos,state.capturedPhotos.forEach((e,t)=>{const a=document.createElement("div");a.className="photo-item";const o=document.createElement("img");o.src=e,o.dataset.index=t,a.appendChild(o),photoGridContainer.appendChild(a)}),showScreen("photo-selection")}photoGridContainer.addEventListener("click",e=>{"IMG"===e.target.tagName&&(!e.target.classList.contains("selected")&&photoGridContainer.querySelectorAll("img.selected").length>=state.requiredPhotos?alert(`ì‚¬ì§„ì€ ${state.requiredPhotos}ì¥ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`):e.target.classList.toggle("selected"))}),nextToEditorBtn.addEventListener("click",()=>{const e=photoGridContainer.querySelectorAll("img.selected");if(e.length!==state.requiredPhotos)return void alert(`ì •í™•íˆ ${state.requiredPhotos}ì¥ì˜ ì‚¬ì§„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.`);const t=Array.from(e).map(e=>state.capturedPhotos[e.dataset.index]);initEditor(t)});
        function initEditor(e){const t=new Image;state.frameImage=t,t.src=state.selectedFrameSrc,t.onload=()=>{canvas.width=t.width,canvas.height=t.height;const a=e.map(e=>new Promise(t=>{const a=new Image;a.src=e,a.onload=()=>t(a)}));Promise.all(a).then(e=>{state.editedPhotos=e.map((e,t)=>{const a=frameSlots[state.selectedFrameType][t],o=a[0]*canvas.width,n=a[1]*canvas.height,i=a[2]*canvas.width,c=a[3]*canvas.height,r=a[4];let d=i,s=i*(e.height/e.width);return s<c&&(s=c,d=c*(e.width/e.height)),{img:e,x:o+(i-d)/2,y:n+(c-s)/2,width:d,height:s,rotation:0,originalSlot:{x:o,y:n,width:i,height:c,type:r}}}),drawCanvas(),showScreen("editor-screen")})},t.complete&&t.onload()}
        function drawCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height),state.editedPhotos.forEach(e=>{ctx.save();const t=e.originalSlot;"circle"===t.type?(ctx.beginPath(),ctx.arc(t.x+t.width/2,t.y+t.height/2,Math.min(t.width,t.height)/2,0,2*Math.PI),ctx.closePath(),ctx.clip()):(ctx.beginPath(),ctx.rect(t.x,t.y,t.width,t.height),ctx.closePath(),ctx.clip()),ctx.translate(e.x+e.width/2,e.y+e.height/2),ctx.rotate(e.rotation),ctx.translate(-(e.x+e.width/2),-(e.y+e.height/2)),ctx.drawImage(e.img,e.x,e.y,e.width,e.height),ctx.restore()}),state.frameImage&&state.frameImage.complete&&ctx.drawImage(state.frameImage,0,0,canvas.width,canvas.height),activePhoto&&drawHandles(activePhoto)}
        function drawHandles(e){const t=e.x+e.width/2,a=e.y+e.height/2;ctx.save(),ctx.translate(t,a),ctx.rotate(e.rotation),ctx.strokeStyle="#3498db",ctx.lineWidth=2,ctx.strokeRect(-e.width/2,-e.height/2,e.width,e.height),ctx.fillStyle="#3498db",ctx.fillRect(e.width/2-handleSize/2,e.height/2-handleSize/2,handleSize,handleSize),ctx.fillStyle="#e74c3c",ctx.beginPath(),ctx.arc(-e.width/2+handleSize/2,-e.height/2+handleSize/2,handleSize/2,0,2*Math.PI),ctx.fill(),ctx.restore()}function getPointerPos(e){const t=canvas.getBoundingClientRect(),a=canvas.width/t.width,o=canvas.height/t.height,n=e.clientX||e.touches[0].clientX,i=e.clientY||e.touches[0].clientY;return{x:(n-t.left)*a,y:(i-t.top)*o}}function getTransformedCoords(e,t,a){const o=e.x,n=e.y,i=t.x+t.width/2,c=t.y+t.height/2,r=t.rotation,d=Math.cos(-r)*(o-i)-Math.sin(-r)*(n-c)+i,s=Math.sin(-r)*(o-i)+Math.cos(-r)*(n-c)+c;return{x:d,y:s}}function isOverHandle(e,t,a){const o=e.x+e.width,n=e.y+e.height,i=e.x,c=e.y;return"resize"===a?t.x>o-handleSize&&t.x<o+handleSize&&t.y>n-handleSize&&t.y<n+handleSize:"rotate"===a?t.x>i-handleSize&&t.x<i+handleSize&&t.y>c-handleSize&&t.y<c+handleSize:void 0}function handlePointerDown(e){e.preventDefault();const t=getPointerPos(e);if(activePhoto){const a=getTransformedCoords(t,activePhoto);if(isOverHandle(activePhoto,a,"resize"))return isResizing=!0,void(canvas.style.cursor="se-resize");if(isOverHandle(activePhoto,a,"rotate"))return isRotating=!0,void(canvas.style.cursor="crosshair")}activePhoto=null,isDragging=!1,isResizing=!1,isRotating=!1;for(let a=state.editedPhotos.length-1;a>=0;a--){const o=state.editedPhotos[a],n=getTransformedCoords(t,o);if(n.x>=o.x&&n.x<=o.x+o.width&&n.y>=o.y&&n.y<=o.y+o.height){activePhoto=o,isDragging=!0,dragStartX=t.x-o.x,dragStartY=t.y-o.y,canvas.style.cursor="grabbing",state.editedPhotos.splice(a,1),state.editedPhotos.push(o);break}}drawCanvas()}function handlePointerMove(e){if(e.preventDefault(),!activePhoto)return;const t=getPointerPos(e);if(isDragging)activePhoto.x=t.x-dragStartX,activePhoto.y=t.y-dragStartY;else if(isResizing){const a=getTransformedCoords(t,activePhoto),o=a.x-activePhoto.x,n=o*(activePhoto.img.height/activePhoto.img.width);o>20&&(activePhoto.width=o,activePhoto.height=n)}else if(isRotating){const a=activePhoto.x+activePhoto.width/2,o=activePhoto.y+activePhoto.height/2;activePhoto.rotation=Math.atan2(t.y-o,t.x-a)+Math.PI/4}drawCanvas()}function handlePointerUp(e){isDragging=!1,isResizing=!1,isRotating=!1,canvas.style.cursor="grab"}
        
        document.addEventListener('keydown',e=>{
            if(!activePhoto)return;
            if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;
            const t=1.05,a=Math.PI/180;
            let o=!0;
            switch(e.key.toLowerCase()){
                case"w":
                    activePhoto.width*=t;
                    activePhoto.height*=t;
                    break;
                case"s":
                    activePhoto.width/=t;
                    activePhoto.height/=t;
                    break;
                case"a":
                    activePhoto.rotation-=a;
                    break;
                case"d":
                    activePhoto.rotation+=a;
                    break;
                default:
                    o=!1
            }
            o&&(e.preventDefault(),drawCanvas())
        });

        canvas.addEventListener("mousedown",handlePointerDown),canvas.addEventListener("mousemove",handlePointerMove),canvas.addEventListener("mouseup",handlePointerUp),canvas.addEventListener("mouseleave",handlePointerUp),canvas.addEventListener("touchstart",handlePointerDown,{passive:!1}),canvas.addEventListener("touchmove",handlePointerMove,{passive:!1}),canvas.addEventListener("touchend",handlePointerUp),canvas.addEventListener("touchcancel",handlePointerUp);
        
        downloadBtn.addEventListener("click",()=>{
            activePhoto=null;
            drawCanvas();
            
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const filename = `${year}${month}${day}_${hours}${minutes}${seconds}.png`;

            const e=document.createElement("a");
            e.download=filename;
            e.href=canvas.toDataURL("image/png");
            document.body.appendChild(e);
            e.click();
            document.body.removeChild(e);
        });
        
        // --- â­ï¸ ì¸ì‡„í•˜ê¸° ë²„íŠ¼ ë¡œì§ ìˆ˜ì • â­ï¸ ---
        printBtn.addEventListener("click",()=>{
            activePhoto=null;
            drawCanvas();
            const dataUrl = canvas.toDataURL("image/png");
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(`
                <html>
                    <head><title>ì¸ì‡„</title></head>
                    <body style="margin:0;">
                        <img src="${dataUrl}" style="width:100%;">
                    </body>
                </html>
            `);
            printWindow.document.close();
            // ì´ë¯¸ì§€ê°€ ìƒˆ ì°½ì— ì™„ì „íˆ ë¡œë“œëœ í›„ ì¸ì‡„ ë° ì°½ ë‹«ê¸° ì‹¤í–‰
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        });
        
        restartBtn.addEventListener("click",()=>{state={selectedFrameSrc:null,selectedFrameType:null,requiredPhotos:0,capturedPhotos:[],editedPhotos:[],frameImage:null},activePhoto=null,isDragging=!1,isResizing=!1,isRotating=!1,captureCountSpan.textContent="0",captureBtn.disabled=!1,autoCapture1sBtn.disabled=!1,autoCapture3sBtn.disabled=!1,nextToSelectionBtn.disabled=!0,thumbnailsContainer.innerHTML="",showScreen("frame-selection")});
    </script>
</body>
</html>