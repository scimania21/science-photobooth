<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제27회 인천과학대제전 과학네컷</title>
    <style>
        body{font-family:'Malgun Gothic',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;background-color:#f0f2f5;color:#333}
        .screen{display:none;width:100%;max-width:1000px;padding:20px;box-sizing:border-box;text-align:center}
        .screen.active{display:block}
        h1,h2{color:#2c3e50}
        button{background-color:#3498db;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;cursor:pointer;transition:background-color .3s;margin:5px}
        button:hover{background-color:#2980b9}
        button:disabled{background-color:#bdc3c7;cursor:not-allowed}
        #frame-selection .frame-options{display:flex;flex-direction:column;align-items:center;gap:20px}
        #frame-selection .frame-row{display:flex;justify-content:center;gap:20px;flex-wrap:wrap}
        #frame-selection img{box-sizing:border-box;width:200px;border:3px solid transparent;border-radius:10px;cursor:pointer;transition:border-color .3s,transform .3s;background-color:#fff}
        #frame-selection img:hover{border-color:#3498db;transform:scale(1.05)}
        #video-container{position:relative;width:100%;max-width:500px;margin:0 auto}
        #capture-screen video{width:100%;border-radius:10px;background-color:#000;display:block;transform:scaleX(-1)}
        #countdown-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;font-size:150px;font-weight:700;color:#fff;text-shadow:2px 2px 8px rgba(0,0,0,.8);-webkit-text-stroke:2px #000}
        #capture-controls{margin-top:15px}
        #stop-capture-btn{background-color:#e74c3c}
        #thumbnails{display:flex;flex-wrap:nowrap;gap:10px;justify-content:flex-start;margin-top:15px;height:80px;overflow-y:hidden;overflow-x:auto;padding:10px;background:#fff;border-radius:5px}
        #thumbnails img{width:80px;height:60px;object-fit:cover;border-radius:5px;flex-shrink:0}
        #photo-selection .photo-grid{display:grid;grid-template-columns:repeat(5, 1fr);gap:15px;margin:20px 0}
        #photo-selection .photo-item img{width:100%;border-radius:5px;display:block;border:4px solid transparent;cursor:pointer;transition:border-color .2s}
        #photo-selection .photo-item img.selected{border-color:#3498db}
        #editor-screen canvas{border:2px solid #ccc;border-radius:5px;cursor:grab;max-width:100%;height:auto;touch-action:none}
        .instructions{background-color:#eaf5ff;border:1px solid #bce8f1;color:#31708f;padding:15px;border-radius:8px;margin-bottom:20px}
    </style>
</head>
<body>

    <div id="frame-selection" class="screen active">
        <h1>📸 제27회 인천과학대제전 과학네컷 📸</h1>
        <p class="instructions">마음에 드는 프레임을 선택하세요.</p>
        <div class="frame-options">
            <div class="frame-row">
                <img src="1번 프레임.png" alt="프레임 1" data-frame="1번 프레임.png" data-photos="4" data-photo-slots="frame_01_slots">
                <img src="2번 프레임.png" alt="프레임 2" data-frame="2번 프레임.png" data-photos="4" data-photo-slots="frame_02_slots">
                <img src="3번 프레임.png" alt="프레임 3" data-frame="3번 프레임.png" data-photos="8" data-photo-slots="frame_03_slots">
                <img src="4번 프레임.png" alt="프레임 4" data-frame="4번 프레임.png" data-photos="4" data-photo-slots="frame_04_slots">
            </div>
            <div class="frame-row">
                <img src="5번 프레임.png" alt="프레임 5" data-frame="5번 프레임.png" data-photos="8" data-photo-slots="frame_05_slots">
                <img src="6번 프레임.png" alt="프레임 6" data-frame="6번 프레임.png" data-photos="6" data-photo-slots="frame_06_slots">
                <img src="7번 프레임.png" alt="프레임 7" data-frame="7번 프레임.png" data-photos="8" data-photo-slots="frame_07_slots">
                <img src="8번 프레임.png" alt="프레임 8" data-frame="8번 프레임.png" data-photos="4" data-photo-slots="frame_08_slots">
            </div>
        </div>
    </div>
    <div id="capture-screen" class="screen">
        <h2>📷 사진 촬영 (<span id="capture-count">0</span>/10)</h2>
        <p class="instructions">원하는 촬영 방식을 선택하세요.</p>
        <div id="video-container">
            <video id="webcam" autoplay playsinline></video>
            <div id="countdown-overlay"></div>
        </div>
        <div id="capture-controls">
            <button id="manual-capture-btn">수동촬영</button>
            <button id="auto-capture-1s-btn">1초 자동촬영</button>
            <button id="auto-capture-3s-btn">3초 자동촬영</button>
            <button id="auto-capture-5s-btn">5초 자동촬영</button>
            <button id="stop-capture-btn" style="display:none">촬영 중지</button>
        </div>
        <button id="next-to-selection-btn" disabled>사진 선택하기</button>
        <h3>촬영된 사진 목록</h3>
        <div id="thumbnails"></div>
    </div>
    <div id="photo-selection" class="screen">
        <h2>🖼️ 사진 선택</h2>
        <p class="instructions">프레임에 넣을 <b id="required-photos-count"></b>장의 사진을 선택한 후, '편집 화면으로' 버튼을 눌러주세요.</p>
        <div id="photo-grid-container" class="photo-grid"></div>
        <button id="next-to-editor-btn">편집 화면으로</button>
    </div>
    <div id="editor-screen" class="screen">
        <h2>🎨 사진 편집</h2>
        <p class="instructions">사진을 드래그하여 위치를 옮기고, 핸들이나 단축키(W/A/S/D)로 크기와 방향을 조절하세요.</p>
        <canvas id="canvas"></canvas>
        <div class="controls" style="margin-top:20px">
            <button id="download-btn">이미지 다운로드</button>
            <button id="print-btn">인쇄하기</button>
            <button id="restart-btn">처음으로</button>
        </div>
    </div>

    <audio id="shutter-sound" src="https://www.soundjay.com/mechanical/camera-shutter-click-01.wav" preload="auto"></audio>

    <script>
        const screens=document.querySelectorAll(".screen"),frameSelectionScreen=document.getElementById("frame-selection"),captureScreen=document.getElementById("capture-screen"),photoSelectionScreen=document.getElementById("photo-selection"),editorScreen=document.getElementById("editor-screen"),webcamElement=document.getElementById("webcam"),canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),captureCountSpan=document.getElementById("capture-count"),manualCaptureBtn=document.getElementById("manual-capture-btn"),autoCapture1sBtn=document.getElementById("auto-capture-1s-btn"),autoCapture3sBtn=document.getElementById("auto-capture-3s-btn"),autoCapture5sBtn=document.getElementById("auto-capture-5s-btn"),stopCaptureBtn=document.getElementById("stop-capture-btn"),countdownOverlay=document.getElementById("countdown-overlay"),thumbnailsContainer=document.getElementById("thumbnails"),nextToSelectionBtn=document.getElementById("next-to-selection-btn"),photoGridContainer=document.getElementById("photo-grid-container"),requiredPhotosCountSpan=document.getElementById("required-photos-count"),nextToEditorBtn=document.getElementById("next-to-editor-btn"),downloadBtn=document.getElementById("download-btn"),printBtn=document.getElementById("print-btn"),restartBtn=document.getElementById("restart-btn"),shutterSound=document.getElementById("shutter-sound");
        let state={selectedFrameSrc:null,selectedFrameType:null,requiredPhotos:0,capturedPhotos:[],editedPhotos:[],frameImage:null},activePhoto=null,isDragging=!1,isResizing=!1,isRotating=!1,dragStartX,dragStartY;const handleSize=16;let autoCaptureTimer=null,countdownInterval=null;
        const frameSlots={frame_01_slots:[[.0536,.2347,.4229,.341],[.0536,.5927,.4229,.341],[.5313,.0694,.4229,.341],[.5313,.4264,.4229,.341]],frame_02_slots:[[.0651,.0317,.4209,.3968],[.0651,.4476,.4209,.3968],[.514,.081,.4209,.3968],[.514,.5,.4209,.3968]],frame_03_slots:[[.1751,.1863,.261,.1261],[.1751,.3353,.261,.1261],[.1941,.4854,.261,.1261],[.196,.6398,.261,.1261],[.5567,.2528,.261,.1261],[.5577,.3991,.261,.1261],[.5225,.5475,.261,.1261],[.5078,.7043,.261,.1261]],frame_04_slots:[[.1591,.209,.3361,.3079],[.5067,.209,.3361,.3079],[.1591,.5257,.3361,.3079],[.5078,.5241,.3361,.3079]],frame_05_slots:[[.0498,.0143,.419,.1981],[.0498,.2286,.419,.1981],[.0498,.4434,.419,.1981],[.0498,.6579,.419,.1981],[.5488,.0143,.419,.1981],[.5488,.2286,.419,.1981],[.5488,.4434,.419,.1981],[.5488,.6579,.419,.1981]],frame_06_slots:[[.0629,.3656,.2821,.2021],[.3704,.3598,.2581,.1984],[.6532,.3735,.2709,.1952],[.0928,.655,.2626,.1942],[.3771,.6688,.2447,.1884],[.6539,.6519,.2634,.1979]],frame_07_slots:[[.0565,.1706,.3958,.1817],[.0565,.3728,.3958,.1817],[.0565,.5741,.3958,.1817],[.0565,.7767,.3958,.1817],[.5537,.1706,.3958,.1817],[.5537,.3728,.3958,.1817],[.5537,.5741,.3958,.1817],[.5537,.7767,.3958,.1817]],frame_08_slots:[[.0135,.1675,.4747,.3921],[.0135,.5778,.4747,.3921],[.4994,.0254,.4747,.3921],[.4994,.4365,.4747,.3921]]};
        Object.keys(frameSlots).forEach(e=>{frameSlots[e].forEach(e=>{e.length<5&&e.push("square")})});
        
        function showScreen(e){screens.forEach(t=>t.classList.remove("active")),document.getElementById(e).classList.add("active")}
        frameSelectionScreen.addEventListener("click",e=>{"IMG"===e.target.tagName&&(state.selectedFrameSrc=e.target.dataset.frame,state.selectedFrameType=e.target.dataset.photoSlots,state.requiredPhotos=parseInt(e.target.dataset.photos),startWebcam())});
        async function startWebcam(){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});webcamElement.srcObject=e,showScreen("capture-screen")}catch(e){console.error("웹캠 접근 오류:",e),alert("웹캠에 접근할 수 없습니다. 카메라 권한을 허용해주세요.")}}
        
        // --- ⭐️⭐️⭐️ 좌우 반전 로직 수정 ⭐️⭐️⭐️ ---
        function capturePhoto(){
            if (state.capturedPhotos.length >= 10) {
                stopAutoCapture();
                return;
            }
            shutterSound.currentTime = 0;
            shutterSound.play();
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = webcamElement.videoWidth;
            tempCanvas.height = webcamElement.videoHeight;
            const tempCtx = tempCanvas.getContext("2d");
            
            // 🚨 좌우 반전 로직 제거! 🚨
            // 이제 비디오에 보이는 그대로(실제 모습)를 캡처합니다.
            // tempCtx.translate(tempCanvas.width, 0);
            // tempCtx.scale(-1, 1);
            tempCtx.drawImage(webcamElement, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const dataUrl = tempCanvas.toDataURL("image/jpeg");
            state.capturedPhotos.push(dataUrl);
            const img = document.createElement("img");
            img.src = dataUrl;
            thumbnailsContainer.appendChild(img);
            captureCountSpan.textContent = state.capturedPhotos.length;
            
            if (state.capturedPhotos.length >= 10) {
                toggleCaptureButtons(true);
                nextToSelectionBtn.disabled = false;
                stopAutoCapture();
            }
        }
        
        function runCountdown(e,t){let a=e;countdownOverlay.style.display="flex";const o=()=>{countdownOverlay.textContent=a,a<1?(clearInterval(countdownInterval),countdownOverlay.style.display="none",t()):a--};o(),countdownInterval=setInterval(o,1e3)}
        function startAutoCapture(e){if(state.capturedPhotos.length>=10)return;toggleCaptureButtons(!0),stopCaptureBtn.style.display="inline-block";const t=()=>{state.capturedPhotos.length>=10?stopAutoCapture():runCountdown(e,()=>{capturePhoto(),state.capturedPhotos.length<10&&(autoCaptureTimer=setTimeout(t,1e3))})};t()}
        function stopAutoCapture(){clearTimeout(autoCaptureTimer),clearInterval(countdownInterval),autoCaptureTimer=null,countdownInterval=null,countdownOverlay.style.display="none",stopCaptureBtn.style.display="none",toggleCaptureButtons(state.capturedPhotos.length>=10)}
        function toggleCaptureButtons(e){manualCaptureBtn.disabled=e,autoCapture1sBtn.disabled=e,autoCapture3sBtn.disabled=e,autoCapture5sBtn.disabled=e}
        manualCaptureBtn.addEventListener("click",capturePhoto),autoCapture1sBtn.addEventListener("click",()=>startAutoCapture(1)),autoCapture3sBtn.addEventListener("click",()=>startAutoCapture(3)),autoCapture5sBtn.addEventListener("click",()=>startAutoCapture(5)),stopCaptureBtn.addEventListener("click",stopAutoCapture);
        nextToSelectionBtn.addEventListener("click",()=>{stopAutoCapture(),webcamElement.srcObject&&webcamElement.srcObject.getTracks().forEach(e=>e.stop()),setupPhotoSelection()});
        function setupPhotoSelection(){photoGridContainer.innerHTML="",requiredPhotosCountSpan.textContent=state.requiredPhotos,state.capturedPhotos.forEach((e,t)=>{const a=document.createElement("div");a.className="photo-item";const o=document.createElement("img");o.src=e,o.dataset.index=t,a.appendChild(o),photoGridContainer.appendChild(a)}),showScreen("photo-selection")}
        photoGridContainer.addEventListener("click",e=>{"IMG"===e.target.tagName&&(!e.target.classList.contains("selected")&&photoGridContainer.querySelectorAll("img.selected").length>=state.requiredPhotos?alert(`사진은 ${state.requiredPhotos}장까지만 선택할 수 있습니다.`):e.target.classList.toggle("selected"))});
        nextToEditorBtn.addEventListener("click",()=>{const e=photoGridContainer.querySelectorAll("img.selected");if(e.length!==state.requiredPhotos)return void alert(`정확히 ${state.requiredPhotos}장의 사진을 선택해야 합니다.`);const t=Array.from(e).map(e=>state.capturedPhotos[e.dataset.index]);initEditor(t)});
        function initEditor(e){const t=new Image;state.frameImage=t,t.src=state.selectedFrameSrc,t.onload=()=>{canvas.width=t.width,canvas.height=t.height;const a=e.map(e=>new Promise(t=>{const a=new Image;a.src=e,a.onload=()=>t(a)}));Promise.all(a).then(e=>{state.editedPhotos=e.map((e,t)=>{const a=frameSlots[state.selectedFrameType][t],o=a[0]*canvas.width,n=a[1]*canvas.height,i=a[2]*canvas.width,c=a[3]*canvas.height,r=a[4];let d=i,s=i*(e.height/e.width);return s<c&&(s=c,d=c*(e.width/e.height)),{img:e,x:o+(i-d)/2,y:n+(c-s)/2,width:d,height:s,rotation:0,originalSlot:{x:o,y:n,width:i,height:c,type:r}}}),drawCanvas(),showScreen("editor-screen")})},t.complete&&t.onload()}
        function drawCanvas(){ctx.clearRect(0,0,canvas.width,canvas.height),state.editedPhotos.forEach(e=>{ctx.save();const t=e.originalSlot;"circle"===t.type?(ctx.beginPath(),ctx.arc(t.x+t.width/2,t.y+t.height/2,Math.min(t.width,t.height)/2,0,2*Math.PI),ctx.closePath(),ctx.clip()):(ctx.beginPath(),ctx.rect(t.x,t.y,t.width,t.height),ctx.closePath(),ctx.clip()),ctx.translate(e.x+e.width/2,e.y+e.height/2),ctx.rotate(e.rotation),ctx.translate(-(e.x+e.width/2),-(e.y+e.height/2)),ctx.drawImage(e.img,e.x,e.y,e.width,e.height),ctx.restore()}),state.frameImage&&state.frameImage.complete&&ctx.drawImage(state.frameImage,0,0,canvas.width,canvas.height),activePhoto&&drawHandles(activePhoto)}
        function drawHandles(e){const t=e.x+e.width/2,a=e.y+e.height/2;ctx.save(),ctx.translate(t,a),ctx.rotate(e.rotation),ctx.strokeStyle="#3498db",ctx.lineWidth=2,ctx.strokeRect(-e.width/2,-e.height/2,e.width,e.height),ctx.fillStyle="#3498db",ctx.fillRect(e.width/2-handleSize/2,e.height/2-handleSize/2,handleSize,handleSize),ctx.fillStyle="#e74c3c",ctx.beginPath(),ctx.arc(-e.width/2+handleSize/2,-e.height/2+handleSize/2,handleSize/2,0,2*Math.PI),ctx.fill(),ctx.restore()}
        function getPointerPos(e){const t=canvas.getBoundingClientRect(),a=canvas.width/t.width,o=canvas.height/t.height,n=e.clientX||e.touches[0].clientX,i=e.clientY||e.touches[0].clientY;return{x:(n-t.left)*a,y:(i-t.top)*o}}
        function getTransformedCoords(e,t,a){const o=e.x,n=e.y,i=t.x+t.width/2,c=t.y+t.height/2,r=t.rotation,d=Math.cos(-r)*(o-i)-Math.sin(-r)*(n-c)+i,s=Math.sin(-r)*(o-i)+Math.cos(-r)*(n-c)+c;return{x:d,y:s}}
        function isOverHandle(e,t,a){const o=e.x+e.width,n=e.y+e.height,i=e.x,c=e.y;return"resize"===a?t.x>o-handleSize&&t.x<o+handleSize&&t.y>n-handleSize&&t.y<n+handleSize:"rotate"===a?t.x>i-handleSize&&t.x<i+handleSize&&t.y>c-handleSize&&t.y<c+handleSize:void 0}
        function handlePointerDown(e){e.preventDefault();const t=getPointerPos(e);if(activePhoto){const a=getTransformedCoords(t,activePhoto);if(isOverHandle(activePhoto,a,"resize"))return isResizing=!0,void(canvas.style.cursor="se-resize");if(isOverHandle(activePhoto,a,"rotate"))return isRotating=!0,void(canvas.style.cursor="crosshair")}activePhoto=null,isDragging=!1,isResizing=!1,isRotating=!1;for(let a=state.editedPhotos.length-1;a>=0;a--){const o=state.editedPhotos[a],n=getTransformedCoords(t,o);if(n.x>=o.x&&n.x<=o.x+o.width&&n.y>=o.y&&n.y<=o.y+o.height){activePhoto=o,isDragging=!0,dragStartX=t.x-o.x,dragStartY=t.y-o.y,canvas.style.cursor="grabbing",state.editedPhotos.splice(a,1),state.editedPhotos.push(o);break}}drawCanvas()}
        function handlePointerMove(e){if(e.preventDefault(),!activePhoto)return;const t=getPointerPos(e);if(isDragging)activePhoto.x=t.x-dragStartX,activePhoto.y=t.y-dragStartY;else if(isResizing){const a=getTransformedCoords(t,activePhoto),o=a.x-activePhoto.x,n=o*(activePhoto.img.height/activePhoto.img.width);o>20&&(activePhoto.width=o,activePhoto.height=n)}else if(isRotating){const a=activePhoto.x+activePhoto.width/2,o=activePhoto.y+activePhoto.height/2;activePhoto.rotation=Math.atan2(t.y-o,t.x-a)+Math.PI/4}drawCanvas()}
        function handlePointerUp(e){isDragging=!1,isResizing=!1,isRotating=!1,canvas.style.cursor="grab"}
        document.addEventListener('keydown',e=>{if(!activePhoto)return;if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName)return;const t=1.05,a=Math.PI/180;let o=!0;switch(e.key.toLowerCase()){case"w":activePhoto.width*=t,activePhoto.height*=t;break;case"s":activePhoto.width/=t,activePhoto.height/=t;break;case"a":activePhoto.rotation-=a;break;case"d":activePhoto.rotation+=a;break;default:o=!1}o&&(e.preventDefault(),drawCanvas())});
        canvas.addEventListener("mousedown",handlePointerDown),canvas.addEventListener("mousemove",handlePointerMove),canvas.addEventListener("mouseup",handlePointerUp),canvas.addEventListener("mouseleave",handlePointerUp),canvas.addEventListener("touchstart",handlePointerDown,{passive:!1}),canvas.addEventListener("touchmove",handlePointerMove,{passive:!1}),canvas.addEventListener("touchend",handlePointerUp),canvas.addEventListener("touchcancel",handlePointerUp);
        downloadBtn.addEventListener("click",()=>{activePhoto=null,drawCanvas();const e=new Date,t=String(e.getFullYear())+String(e.getMonth()+1).padStart(2,"0")+String(e.getDate()).padStart(2,"0")+"-"+String(e.getHours()).padStart(2,"0")+String(e.getMinutes()).padStart(2,"0")+String(e.getSeconds()).padStart(2,"0"),a=document.createElement("a");a.download=`${t}.png`,a.href=canvas.toDataURL("image/png"),document.body.appendChild(a),a.click(),document.body.removeChild(a)});
        printBtn.addEventListener("click",()=>{activePhoto=null,drawCanvas();const e=canvas.toDataURL("image/png"),t=window.open("","","width=800,height=600");t.document.open(),t.document.write(`\n                <!DOCTYPE html>\n                <html>\n                <head><title>Print</title></head>\n                <body><img src="${e}" style="max-width: 100%;"></body>\n                </html>\n            `),t.document.close(),t.focus(),t.print(),t.close()});
        restartBtn.addEventListener("click",()=>{stopAutoCapture(),webcamElement.srcObject&&(webcamElement.srcObject.getTracks().forEach(e=>e.stop()),webcamElement.srcObject=null),state={selectedFrameSrc:null,selectedFrameType:null,requiredPhotos:0,capturedPhotos:[],editedPhotos:[],frameImage:null},activePhoto=null,isDragging=!1,isResizing=!1,isRotating=!1,captureCountSpan.textContent="0",toggleCaptureButtons(!1),nextToSelectionBtn.disabled=!0,thumbnailsContainer.innerHTML="",showScreen("frame-selection")});
        showScreen("frame-selection");
    </script>
</body>
</html>